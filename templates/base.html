<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#0b1020">
  <title>{% block title %}LabangOnline{% endblock %}</title>
  {% load static %}
  <link rel="icon" href="{% static 'logo.png' %}" type="image/png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/app.css' %}">
  <link rel="stylesheet" href="{% static 'css/base_extras.css' %}">
  {% block head %}{% endblock %}
</head>
<body>
  <header class="site-header">
    <div class="container flex between center" style="padding-top:10px; padding-bottom:10px;">
      <a class="brand" href="/">
        <img src="{% static 'logo.png' %}" alt="LabangOnline" class="logo">
        <span>LabangOnline</span>
      </a>
      <nav class="nav" style="display:flex;align-items:center;gap:16px">
        {% if user.is_authenticated and not hide_user_nav %}
          <!-- Authenticated user navigation -->
          <div class="auth-nav">
            <div class="user-info">
              {% if user.profile_photo_url %}
                <img src="{{ user.profile_photo_url }}" alt="{{ user.full_name }}" class="user-avatar">
              {% else %}
                <img src="{% static 'icons/default_user.png' %}" alt="{{ user.full_name }}" class="user-avatar">
              {% endif %}
              <span class="user-name">{{ user.full_name }}</span>
            </div>
            <a href="{% url 'accounts:personal_info' %}" class="btn-dashboard">Dashboard</a>
          </div>
        {% elif not user.is_authenticated %}
          <!-- Non-authenticated user navigation -->
          <a href="/accounts/register/">Register</a>
          <a href="/accounts/login/">Login</a>
        {% endif %}
        <button id="mode-toggle" class="btn" style="padding:8px 12px">Toggle</button>
      </nav>
    </div>
  </header>

  <main class="site-main">
    <div class="container">
      {% block content %}{% endblock %}
    </div>
  </main>

  <footer class="site-footer">
    <div class="container">
      <p>© {% now 'Y' %} Barangay Labangon • LabangOnline</p>
    </div>
  </footer>

  {% block scripts %}{% endblock %}
  <script>
    // Enhanced persistent dark/light mode system
    (function() {
      const btn = document.getElementById('mode-toggle');
      const key = 'labang-theme-mode';
      const html = document.documentElement;
      
      // Theme management
      function applyTheme(theme) {
        // Remove existing theme classes
        html.classList.remove('light', 'dark');
        
        // Apply new theme
        html.classList.add(theme);
        
        // Update button text and state
        if (btn) {
          btn.textContent = theme === 'light' ? 'Dark Mode' : 'Light Mode';
          btn.setAttribute('aria-pressed', theme === 'light' ? 'false' : 'true');
          btn.setAttribute('data-theme', theme);
        }
        
        // Update meta theme-color for mobile browsers
        const metaThemeColor = document.querySelector('meta[name="theme-color"]');
        if (metaThemeColor) {
          metaThemeColor.content = theme === 'light' ? '#ffffff' : '#0b1020';
        }
      }
      
      // Initialize theme
      function initTheme() {
        const saved = localStorage.getItem(key);
        const systemPrefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
        
        // Priority: saved preference -> system preference -> dark (default)
        const initialTheme = saved || (systemPrefersLight ? 'light' : 'dark');
        applyTheme(initialTheme);
      }
      
      // Toggle theme
      function toggleTheme() {
        const currentTheme = html.classList.contains('light') ? 'light' : 'dark';
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        
        localStorage.setItem(key, newTheme);
        applyTheme(newTheme);
        
        // Add smooth transition
        html.style.transition = 'background-color 0.3s ease, color 0.3s ease';
        setTimeout(() => {
          html.style.transition = '';
        }, 300);
      }
      
      // Initialize on DOM ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initTheme);
      } else {
        initTheme();
      }
      
      // Add click listener
      if (btn) {
        btn.addEventListener('click', toggleTheme);
      }
      
      // Listen for system theme changes
      if (window.matchMedia) {
        window.matchMedia('(prefers-color-scheme: light)').addEventListener('change', (e) => {
          // Only update if no saved preference
          if (!localStorage.getItem(key)) {
            applyTheme(e.matches ? 'light' : 'dark');
          }
        });
      }
    })();
  </script>
</body>
</html>